\documentclass{article} 
\usepackage{polyglossia} 
\usepackage{amsmath}
\usepackage{fontspec} 
\usepackage{lipsum} 
\usepackage[margin=1in]{geometry}
\usepackage{graphicx} 
\usepackage{caption} 
\usepackage{subcaption}
\usepackage{hyperref} 
\usepackage{listing}
\hypersetup{% 
    colorlinks=true, linkcolor=blue, filecolor=magenta,      
    urlcolor=cyan, 
    pdfinfo = {%
        Title = Συστήματα Πολυμέσων Υλοποίηση GSM 06.10,
        Author = {Χρήστος Μάριος Περδίκης, Γιώργος Βακασίρης},
        Producer = XeLaTeX,
    } 
}

\setmainfont{FreeSans}


\title{Πλήρωση Πολυγώνων}
\date{Εαρινό Εξάμηνο 2024-2025}
\author{Χρήστος-Μάριος Περδίκης 10075 cperdikis@ece.auth.gr}

\begin{document}
\maketitle

Αυτή είναι η αναφορά για την πρώτη εργασία του μαθήματος Γραφική με 
Υπολογιστές, εαρινό εξάμηνο 2024-2025. Στόχος της η υλοποίηση αλγορίθμου
πλήρωσης τριγώνων και η χρωμάτισή τους με flat και texture map
shading. Ακολουθεί περιγραφή της υλοποίησης.

\section{Γενική δομή}
Η υλοποίηση της γραμμικής παρεμβολής βρίσκεται στο αρχείο ``vec\_inter.py''.
Η υλοποίηση των αλγορίθμων πλήρωσης τριγώνων και χρωματισμού βρίσκεται
στο ``polygon\_fill.py''. Στα αρχεία ``demo\_f.py'', ``demo\_g.py'' (demos για flat και texture shading
αντίστοιχα) φορτώνονται τα δεδομένα των vertices, faces, κλπ. και καλείται η
συνάρτηση \verb|render_img|.  Σε αυτή δημιουργείται μια νέα εικόνα λευκού background
και δια\-στάσεων $512\times512$, υπολογίζεται το κέντρο βάρους βάθους των κορυφών
όλων των τριγώνων, και ζωγρα\-φίζονται ένα-ένα από τη συνάρτηση \verb|polygon_fill|
κατά φθίνουσα σειρά βάθους τριγώνου.  Η \verb|polygon_fill| υλοποιεί τον αλγόριθμο
πλήρωσης τριγώνων και καλεί τις συναρτήσεις \verb|t_shading| και
\verb|f_shading|. Όταν ολοκληρωθεί η τελική εικόνα, αυτή αποθηκεύεται σε αρχείο
``texture\_shading.png'' ή ``flat\_shading.png'' για texture map shading και flat shading αντίστοιχα.

Για την επεξεργασία και την αποθήκευση των εικόνων χρησιμοποιήθηκε η βιβλιοθήκη
opencv. Χρησιμο\-ποιήθηκαν επίσης οι βιβλιοθήκες numpy για τη χρήση arrays και
math για την αναπαράασταση του απείρου

\section{Γραμμική Παρεμβολή}
Η γραμμική παρεμβολή υλοποιείται στην συνάρτηση \verb|vector_inter| του αρχείου 
``vec\_inter.py''. Έχει ως εισόδους δύο σημεία $p1$, $p2$, δύο διανύσματα $V1$,
$V2$, τη συντεταγμένη x ή y στην οποία θα γίνει παρεμβολή $coord$ και τη μεταβλητή
$dim$ που υποδεικνύει αν η $coord$ είναι τεταγμένη ή τετμημένη. Οι μεταβλητές 
$V$, $p$ (αποτελέσματα της γραμμικής παρεμβολής, διάνυσμα και σημείο αντίστοιχα) και 
$lamda$ (συντελεστής παρεμβολής) είναι οι έξοδοι. Η λειτουργία της 
συνάρτησης είναι διαφορετική αν $dim = 1$ (coord τετμημένη) ή αν $dim = 2$ 
($coord$ τεταγμένη). 

Για $dim = 1$, ελέγχουμε αν οι τετμημένες των δύο σημείων 
$p1$, $p2$ είναι πολύ κοντά. Στην περίπτωση που η απόσταση μεταξύ τους είναι μη αμελητέα,
υπολογίζουμε τον συντελεστή παρεμβολής $lamda$ σύμφωνα με την εξίσωση:

\begin{equation}
    \lambda = - \frac{x_{p2} - coord}{x_{p1} - x_{p2}}
\end{equation}
και έπειτα εκτελούμε γραμμική παρεμβολή ως εξής:

\begin{gather}
    y_p = \lambda y_{p1} + (1-\lambda) y_{p2}\label{lerp_dim1} \\
    x_p = coord\label{lerp_dim1_2}
\end{gather}
Στην περίπτωση που είναι πολύ κοντά, θέτουμε αυθαίρετα
$lamda = 0$ και εκτελούμε γραμμική παρεμβολή όπως στις
εξισώσεις~\ref{lerp_dim1} και~\ref{lerp_dim1_2}. Η συνάρτηση της γραμμικής παρεμβολής 
τότε επιστρέφει $p = p2$. Εφόσον θεωρούμε ότι η $coord$ βρίσκεται στο
ευθύγραμμο τμήμα $p1p2$, δηλαδή ενδιάμεσα των $p1$, $p2$, 
και τα $p1$, $p2$ είναι πολύ κοντά, αυτό είναι αποδεκτό.

Για $dim = 2$ γίνεται όμοια διαδικασία με πριν. Όμως ελέγχονται
αν οι τεταγμένες των σημείων $p1$, $p2$ είναι πολύ κοντά και οι νέες 
εξισώσεις είναι:

\begin{gather}
    \lambda = - \frac{y_{p2} - coord}{y_{p1} - y_{p2}}\\
    x_p = \lambda x_{p1} + (1-\lambda) x_{p2}\label{lerp_dim2} \\
    y_p = coord\label{lerp_dim2_2}
\end{gather}

Τέλος, υπολογίζουμε το διάνυσμα εξόδου:

\begin{equation}
    V = \lambda V_{1} + (1-\lambda) V_{2}
\end{equation}

\section{Αλγόριθμος Πλήρωσης Πολυγώνων}
Ο αλγόριθμος πλήρωσης τριγώνων υλοποιείται στη συνάρτηση \verb|polygon_fill|,
με κάθε κλήσης της συνά\-ρτησης πληρείται ένα τρίγωνο. Για κάθε πλευρά ενός 
τριγώνου υπολογίζονται τα $y_{max}$, $y_{min}$, $x_{max}$, $x_{min}$ 
και η κλίση $m_k$. Μετά αρχικοποιούνται οι λίστες ενεργών ακμών και ενεργών 
οριακών σημείων. Στην αρχικοποίηση αυτή το scanline έχει τιμή $y = min(y_{min}) - 1$.
Οι δύο λίστες είναι numpy arrays. Οποιοδήποτε στοιχείο του array ενεργών σημείων που δεν 
είναι $(-1, -1)$ είναι ενεργό. Αντίστοιχα οποιαδήποτε ακμή που δεν αποτελείται από 
δύο σημεία $(-1, -1)$ είναι ενεργή.

Η λούπα πλήρωσης τριγώνων ξεκινάει για $y = min(y_{min})$ και τερματίζει για
$y = max(y_{max})$. Για κάθε iteration της λούπας, η λίστα ενεργών οριακών 
σημείων ταξινομείται με αύξουσα σειρά κατά $x$. Λόγω της κυρτότητας του
τριγώνου, μόνο δύο σημεία / ακμές 
μπορεί να είναι ενεργές ανά πάσα στιγμή. Άρα το πρώτο σημείο της ταξινομημένης 
λίστας ενεργών οριακών σημείων
θα είναι πάντα το υπολειπόμενο ανένεργο σημείο. Ανάλογα με την τιμή της μεταβλητής 
$shading$, καλείται η αντίστοιχη συνάρτηση χρω\-ματισμού \verb|t_shading| ή 
\verb|f_shading| για τεταγμένη ίση με το τωρινό scanline και τετμημένες στο range 
μεταξύ των δύο ενεργών οριακών σημείων. Μετά ενημερώνονται οι λίστες 
ενεργών οριακών σημείων και ενεργών ακμών και ξεκινά το επόμενο iteration.

Οι συμβάσεις για τα οριακά pixels των τριγώνων τηρούνται. Ο
αλγόριθμος εύρεσης ενεργών ακμών εξασφαλίζει ότι τα οριακά pixels ανάμεσα 
σε δύο τρίγωνα θα ανήκουν στο τρίγωνο με τη μεγαλύτερη τεταγμένη / στο
πιό πάνω τρίγωνο. Η υλοποίηση των συναρτήσεων shading εξασφαλίζουν ότι 
τα συνοριακά pixels θα ανήκουν στο πιο δεξιά τρίγωνο / στο τρίγωνο με
τη μεγαλύτερη τετμημένη.

\subsection{Εύρεση Ενεργών Ακμών}
Για κάθε μια από τις 3 πλευρές ενός τριγώνου γίνονται οι εξής ενέργειες.
Αν η επόμενη θέση του scanline είναι ίση με την ελάχιστη τεταγμένη της πλευράς
$y_{min} = y + 1$, και η πλευρά δεν είναι οριζόντια $y_{max} \neq y_{min}$, τότε 
προσθέτουμε αυτήν την πλευρά στη λίστα ενεργών ακμών. Επειδή δεν είναι
γνωστό ποιά τετμημένη αντιστοιχεί στο $y_{max}$ και ποιά στο $y_{min}$
κάθε πλευράς, χρειάζεται η κλήση της συνάρτησης γραμμικής παρεμβολής.
Γίνεται παρεμβολή μεταξύ των δύο σημείων της πλευράς στις τεταγμένες
$y_{max}$ και $y_{min}$ και η συνάρτηση \verb|vector_inter| επιστρέφει
τις τετμημένες τους. Επειδή
όμως $y_{max}$ και $y_{min}$ είναι οι τεταγμένες των σημείων που
ορίζουν την πλευρά,
είναι πλέον γνωστές οι συντεταγμένες των σημείων της πλευράς
και ποιές τετμημένες αντιστοιχούν στις τεταγμένες $y_{max}$, $y_{min}$.
Τέλος, αν η επόμενη θέση του scanline είναι ίση με τη μέγιστη τεταγμένη
της πλευράς του τριγώνου $y_{max} = y + 1$, η πλευρά αφαιρείται 
από τη λίστα ενεργών ακμών και τα σημεία της αντικαθιστούνται με τιμές $(-1, -1)$.

\subsection{Εύρεση Ενεργών Οριακών Σημείων}
Κάθε ενεργή ακμή θα έχει και ένα ενεργό οριακό σημείο.
Για κάθε μια από τις πλευρές του τριγώνου γίνονται οι εξής ενέργειες.
Αν για την επόμενη θέση του scanline ισχύει $y_{min} = y + 1$, 
τότε στη λίστα ενεργών οριακών σημείων προστίθεται το $y_{min}$
και η αντίστοιχη τετμημένη του (η εύρεση της τετμημένης όμοια με 
πριν, μέσω της συνάρτησης \verb|vector_inter|). Για οποιοδήποτε 
ήδη ενεργό σημείο το οποίο δεν ανήκει σε κατακόρυφη γραμμή, η τετμημένη
του αυξάνεται κατά $1 / m_k$. Δεν είναι απαραίτητη η ενημέρωση 
της τεταγμένης τους, εφόσον αυτή πάντα θα ισούται με την τιμή του τωρινού scanline.
Τέλος, αν η επόμενη θέση του scanline υπερβαίνει τη μέγιστη τεταγμένη
της πλευράς του τριγώνου $y_{max} = y + 1$, ή η πλευρά είναι οριζόντια 
$y_{max} = y_{min}$, τότε το σημείο αφαιρείται από τη λίστα ενεργών
οριακών σημείων, τη θέση του αντικαθιστά σημείο με συντεταγμένες 
$(-1, -1)$.

\section{Flat Shading}
Στη συνάρτηση \verb|f_shading| αρχικά υπολογίζουμε τον μέσο όρο του χρώματος 
κάθε κόρυφης του τριγώνου. Το νέο χρώμα $mean\_color$ υπολογίζεται από 
τον μέσο όρο των κόκκινων συνιστωσών των κορυφών, τον μέσο όρο των 
πράσινων συνιστωσών των κορυφών, κλπ. Ταυτόχρονα γίνεται και μετατροπή 
από το color format RGB του δοθέντος array $vcolors$ στο format BGR
που χρησιμοποιείται από την opencv για απεικόνιση εικόνων. 
Το χρώμα $mean\_colors$ εφόσον μετατραπεί σε 8-bit unsigned integer
BGR, αποδίδεται στα pixels με τεταγμένη ίση με το τωρινό scanline,
και με τετμημένες όλων των σημείων ενδιάμεσα από τα δύο 
τρέχοντα ενεργά οριακά σημεία. Συμπεριλαμβάνονται και οι
τετμημένες των ενεργών οριακών σημείων. Το τρίγωνο πλρώνεται με το 
ίδιο χρώμα σε κάθε σημείο του.

Το πρόγραμμα θεωρεί ότι σε μια εικόνα η κατακόρυφη συνιστώσα αυξάνεται 
``προς τα πάνω'', όμως σε μια εικόνα της opencv η κατακόρυφη συνιστώσα
αυξάνεται ``προς τα κάτω''. Έχουμε ήδη αποφασίσει ότι τα συνοριακά pixel θα 
ανήκουν στο τρίγωνο με την μεγαλύτερη τεταγμένη, άρα για να τηρείται η 
σύμβαση για τον κατακόρυφο άξονα πρέπει να αναστρέψουμε την 
τεταγμένη των σημείων στα οποία αποδίδουμε χρώμα. Δηλαδή 
αποδίδουμε χρώμα στα σημεία με συντεταγμένες
$(x, Y - y)$, όπου $Y$ το κατακόρυφο μέγεθος της εικόνας.


\section{Texture Map Shading}
Η διαδικασία του texture map shading υλοποιείται στη συνάρτηση 
\verb|t_shading|.
Αρχικά τα indices των $vertices$ ταξινομούνται κατά y σε $vtop$,
$vmid$, $vbot$.
Γίνεται γραμμική παρεμβολή με όλους τους πιθανούς συνδυασμούς των $vtop$,
$vmid$, $vbot$ στην τεταγμένη του τρέχοντος scanline y. Αν το scanline y τέμνει την 
αντίστοιχη πλευρά του τριγώνου, δηλαδή αν ο συντελεστής της παρεμβολής $t$ ανήκει στο διάστημα
$0 \leq t \leq 1$, ο $t$ χρησιμοποιείται για να υπολογιστούν οι αντίστοιχες 
τετμημένες στις συντεταγμένες του texture $tex\_left$, $tex\_right$. Στο
screen space αυτές αντιστοιχούν στις $x\_left$, $x\_right$ αντίστοιχα.
Αν η τετμημένη του σημείου που θέλουμε να χρωματίσουμε $x$ ανήκει στο ευθύγραμμο
τμήμα των των σημείων που υπολογίστηκαν με τις προηγούμενες δύο 
γραμμικές παρεμβολές $x\_left$, $x\_right$, τότε εκτελείται γραμμική παρεμβολή
μεταξύ των $x\_left$, $x\_right$ στο σημείο $x$. Με τον συντελεστή της παραπάνω 
πα\-ρεμ\-βολής $kappa$ υπολογίζονται οι συντεταγμένες του αντίστοιχου σημείου 
$tex\_coord$ στο texture map. Οι συν\-τε\-ταγμένες του $tex\_coord$ πολλαπλασιάζονται 
με τις διαστάσεις της εικόνας $tex\_width - 1$ και $tex\_height - 1$ και γίνεται η 
σωστή ανάθεση στην εικόνα $img$. Η κατακόρυφη συνιστώσα της εικόνας $img$ είναι 
ανεστραμμένη για τον ίδιο λόγο που αναφέρθηκε στο flat shading, αλλά
η κατακόρυφη συνιστώσα του texture image δεν είναι.

Σημείωση: δυστυχώς το αποτέλεσμα δεν είναι τέλειο. Υπάρχουν μερικές
οριζόντιες γραμμές---ασυνέ\-χειες στο texture της τελικής εικόνας αλλά δεν γνωρίζω
σε τι οφείλονται. Επίσης δεν κατάφερα να 
χρησιμοποιήσω την συνάρτηση παρεμβολής \verb|vector_inter| επιτυχώς εδώ στη 
συνάρτηση \verb|t_shading|, έκα\-να γραμμική παρεμβολή με νέο κώδικα μέσα
στην \verb|t_shading|.


\vspace{2em}
\centering
\emph{***ΤΕΛΟΣ ΑΝΑΦΟΡΑΣ***}

\end{document}
